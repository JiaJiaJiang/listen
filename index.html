<meta name="viewport" content="width=device-width">
<title>listen</title>
<meta charset="utf-8">
<style>
html{background: #000;}
#control{position: fixed;z-index: 999;width:100%;top:0;left:0;background: #fff;opacity: 0;padding: 0.1em;}
#control:hover{opacity: .9!important;}
.FixTop{opacity: .2!important;}
#control>span:not(:first-child){border-left: 1px solid #ccc;margin-left: 0.1em;padding-left: 0.4em;}
span[title],label,input[type='radio']{cursor: pointer;}
form{display: inline-block;margin: 0;}
[name='musicFile']{width:300px;}
#audio{width:100%;height: 30px;}

#visualGroup{position: absolute;width: 100%;height: 100%;top:0;left: 0;}

#visualGroup.reverse .visualFrame:nth-child(2n){transform: rotateX(180deg);}

.visualFrame{position: absolute;width: 100%;}
.visualFrame canvas{position: absolute;width: 100%;height: 100%;}
.visualFrame #waveCanvas{top:15%;height: 70%;}
.visualFrame #freCanvas{border:.5px dashed #fff3f3b0;box-sizing: border-box;}
#tip{position: fixed;bottom: 0;right: 0;padding: 1em;background: #fff;cursor: pointer;}

</style>
<script src="listen.js"></script>

<div id="canvas_area"></div>
<div id="control">
	<span>
		&nbsp;fft size:<input id="fftSize" type="text" pattern="^\d+$" name="fftSize" value='4096' style="width: 6em;" max="32768" min="2"><span title="must be power of 2, between 32 and 32768"> ‚ö†Ô∏è</span>
	</span>
	<span>
		<form id="freForm">
			frequency:
			<label><input type="radio" name="fre" value="none">none</label>
			<label><input type="radio" name="fre" value="bar">bar</label>
			<label><input type="radio" name="fre" value="waterfall">waterfall</label>
		</form>
	</span>
	<span>
			frequency limit:
			<input type="range" name="lowerLimit"  id="lowerLimit" min="0" max="255" step="1" value="0" style="height: 1em;">
			<input type="number" name="lowerLimitNum" id="lowerLimitNum" min="0" max="255" step="1" value="0" style="width: : 4em;">
	</span>
	<span>wave:
		<form id="waveForm">
			<label><input type="radio" name="wave" value="wave">wave</label>
			<label><input type="radio" name="wave" value="none">none</label>
		</form>
	</span>
	<span>
		<form id="channelMode">
			channel mode:
			<label><input type="radio" name="channelmode" value="split">split</label>
			<label><input type="radio" name="channelmode" value="merge">merge</label>
			&nbsp;
			<button onclick="classToggle(visualGroup.container,'reverse');">reverse 2n channels</button>
		</form>
	</span>
	<span>source:
		<form id="source">
			<label><input type="radio" name="source" value="mic" id="micMode">mic</label>
			<label><input type="radio" name="source" value="music" id="musicMode">music</label>
		</form>
	</span>
	<span>¬©<a href="https://luojia.me" target="_blank">luojia</a></span>
	<span>git:<a href="https://coding.net/u/luojia/p/listen/git" target="_blank">coding.net</a></span>
	<span title="fixed" id="fixTopControl">üìå</span>
	<div id="musicControl">
		<input type="file" name="musicFile" id="musicFile">
		<audio id="audio" controls></audio>
	</div>
</div>

<div id="tip" onclick="this.style.display='none'">This is an audio visualization tool.<br>The source can be your mic or an audio file.<br>The audio file could be dropped in.<br>Click to close.</div>

<script>
// tip.addEventListener('click',()=>{tip});



//funcs
function getQuery(){
	const list=location.hash.substr(1).split('&');
	console.log('args',list)
	const obj={};
	for(let q of list){
		let i=q.indexOf('=');
		if(i>=0){
			obj[q.substring(0,i)]=q.substr(i+1);
		}else{
			obj[q]='';
		}
	}
	return obj;
}
function formQuery(){
	let list=[];
	//console.log(' form args',list)
	for(let s in querys){
		if(querys[s])list.push(`${s}=${querys[s]}`);
		else if(!s){}
		else{list.push(s);}
	}
	return list.join('&');
}
function classToggle(ele,c){
	if(ele.classList.contains(c)){
		ele.classList.remove(c);
	}else{
		ele.classList.add(c);
	}
}

var querys=getQuery();

var eles={};//get all eles with an id
[...document.querySelectorAll('[id]')].forEach(e=>eles[e.id]=e);

try{

	var audioCtx = new AudioContext();
	audioCtx.onstatechange=(e)=>{
		console.log(e)
	}
	window.addEventListener('click',e=>audioCtx.resume());
	window.addEventListener('mouseout',e=>audioCtx.resume());
}catch(e){
	alert('Your browser doesnt support AudioContext');
	throw('abort');
}
let musicSource=audioCtx.createMediaElementSource(eles.audio),
	outputNode = audioCtx.createGain();//for music playing
musicSource.connect(outputNode);
outputNode.connect(audioCtx.destination);

var visualGroup=new VisualGroup(audioCtx);
eles.canvas_area.appendChild(visualGroup.container);





//events
eles.audio.addEventListener('playing',e=>visualGroup.paused=false);
eles.audio.addEventListener('pause',e=>{eles.source.source.value=='music'&&(visualGroup.paused=true)});
window.addEventListener('resize',()=>{visualGroup.canvasSize()});
window.addEventListener('load',()=>{visualGroup.canvasSize()});
window.addEventListener('wheel',e=>e.preventDefault());
eles.control.addEventListener('change',e=>{//listen all changes
	//console.log('input change',e);
	var T=e.target;
	switch(T.name){
		case 'channelmode':
			visualGroup.channelMode(T.value);
			return;
		case 'fre':
			visualGroup.channelFunc('freMode',T.value);
			return;
		case 'wave':
			visualGroup.channelFunc('waveMode',T.value);
			return;
		case 'fftSize':
			const v=Number(T.value);
			if(!(v>=32&&v<=32768)){
				alert('range: 32 to 32768');
				return;
			}
			if(v.toString(2).match(/^10+$/)){
				visualGroup.channelValue('fftSize',v);
			}else{
				alert('the number must be power of 2');
			}
			return;
		case 'source':
			querys.source=T.value;
			location.hash=`#${formQuery()}`;
			setSource(T.value);
			return;
		case 'musicFile':
			eles.audio.src=URL.createObjectURL(T.files[0]);
			eles.audio.play();
			return;
		case 'lowerLimit':
			eles.lowerLimitNum.value=T.value;
			visualGroup.channelValue('lowerLimit',Number(T.value));
			break;
		case 'lowerLimitNum':
			eles.lowerLimit.value=T.value;
			visualGroup.channelValue('lowerLimit',Number(T.value));
			break;
		default:
			console.warn('unhandled change event');
	}
});
eles.fixTopControl.addEventListener('click',e=>{//fix button
	classToggle(eles.control,'FixTop');
});


var unsetSource;
function setSource(s){
	if(unsetSource){
		unsetSource();
		unsetSource=null;
	}
	switch(s){
		case 'mic':{
			eles.source.source.value='mic';
			visualGroup.paused=false;
			eles.musicControl.hidden=true;
			navigator.mediaDevices.getUserMedia({audio:true})
			.then(function(mediaStream){
				let ms=audioCtx.createMediaStreamSource(mediaStream);
				visualGroup.setSource(ms);
				console.log('tracks',ms.mediaStream.getTracks());
				unsetSource=()=>{
					visualGroup.setSource();
					for(let t of ms.mediaStream.getTracks()){
						t.stop();
					}
				}
			}).catch(function(err) {console.log(err);});
			break;
		};
		case 'music':{
			eles.source.source.value='music';
			visualGroup.paused=true;
			eles.musicControl.hidden=false;
			visualGroup.setSource(musicSource);
			// musicSource.connect(outputNode);
			unsetSource=()=>{
				eles.audio.pause();
				visualGroup.setSource();
				// musicSource.disconnect(outputNode);
			}
			break;
		};
		default:alert('unsupported source');
	}
}


window.addEventListener("dragover",function(e) {
	audioCtx.resume();
    e.dataTransfer.dropEffect = "copy";
    e.stopPropagation();
    e.preventDefault();
});
window.addEventListener("drop",function(e) {
	audioCtx.resume();
    e.dataTransfer.dropEffect = "copy";
    e.stopPropagation();
    e.preventDefault();
    eles.musicMode.click();
    eles.musicFile.files=e.dataTransfer.files;
    eles.musicFile.dispatchEvent(new Event("change"));
},false);
window.addEventListener('keydown',e=>{
	if(e.target.tagName=='INPUT')return;
	if(e.code=='Space'){
		if(eles.source.source.value=='mic'){
			visualGroup.paused=!visualGroup.paused;
		}else{
			if(eles.audio.paused)eles.audio.play();
			else{eles.audio.pause();}
		}
	}
});
//draw the canvas
function drawLoop(){
	visualGroup.channelFunc('refresh');
	requestAnimationFrame(drawLoop);
}
requestAnimationFrame(drawLoop);


//prepare data
/*function idelLoop(){
	if(!paused){
		if(!eles.fre_canvas.hidden){
			aPack.collectFre();
			if(eles.freForm.fre.value==='waterfall'){
				visuals.waterfall.map(fre_canvas);
			}
		}
		if(!eles.wave_canvas.hidden)
			aPack.collectWave();
	}
	requestIdleCallback(idelLoop);
}
requestIdleCallback(idelLoop);*/



//init
setSource(querys.source||'mic');
eles.channelMode.channelmode[1].click();
eles.fixTopControl.click();
eles.freForm.fre[2].click();
eles.waveForm.wave[0].click();
// visualGroup.channelMode('merge');
visualGroup.channelValue('fftSize',eles.fftSize.value=4096);


</script>